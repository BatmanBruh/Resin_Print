<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resin Print Catalog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #14141e;
            --accent-cyan: #00d4ff;
            --accent-magenta: #ff006e;
            --accent-amber: #ffbe0b;
            --accent-green: #06d6a0;
            --text-primary: #f0f0f5;
            --text-secondary: #8888aa;
            --text-muted: #555566;
            --border-color: #2a2a3a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(0, 212, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(255, 0, 110, 0.08) 0%, transparent 50%);
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);
        }
        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        h1 {
            font-size: 1.75rem; font-weight: 600;
            background: linear-gradient(90deg, var(--text-primary), var(--accent-cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        h1 span { display: block; font-size: 0.85rem; font-weight: 400; -webkit-text-fill-color: var(--text-secondary); }
        .header-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        button {
            font-family: 'Outfit', sans-serif; padding: 0.75rem 1.5rem; border-radius: 8px;
            border: none; cursor: pointer; font-weight: 500; font-size: 0.9rem;
            transition: all 0.2s ease; display: flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent-cyan), #0099cc); color: var(--bg-primary); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 212, 255, 0.3); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-secondary); border-color: var(--accent-cyan); }
        .btn-danger { background: rgba(255, 0, 110, 0.15); color: var(--accent-magenta); border: 1px solid rgba(255, 0, 110, 0.3); }
        .btn-help { background: var(--bg-tertiary); color: var(--accent-amber); border: 1px solid rgba(255, 190, 11, 0.3); }
        .btn-help:hover { background: rgba(255, 190, 11, 0.1); border-color: var(--accent-amber); }
        .drop-zone {
            border: 2px dashed var(--border-color); border-radius: 16px; padding: 3rem;
            text-align: center; margin-bottom: 2rem; transition: all 0.3s ease;
            background: var(--bg-secondary); cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--accent-cyan); background: rgba(0, 212, 255, 0.05); }
        .drop-zone-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.7; }
        .drop-zone h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
        .drop-zone p { color: var(--text-secondary); font-size: 0.9rem; }
        .table-container { background: var(--bg-card); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; }
        .table-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.5rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);
        }
        .table-title { font-weight: 600; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        .table-actions { display: flex; gap: 0.5rem; }
        .record-count { background: var(--accent-cyan); color: var(--bg-primary); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        thead { background: var(--bg-secondary); position: sticky; top: 0; z-index: 10; }
        th {
            padding: 1rem; text-align: left; font-weight: 600; color: var(--text-secondary);
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
            white-space: nowrap; border-bottom: 1px solid var(--border-color);
            cursor: pointer; user-select: none;
        }
        th:hover { color: var(--accent-cyan); }
        td { padding: 0.875rem 1rem; border: 1px solid var(--border-color); vertical-align: middle; cursor: cell; }
        tr:hover td { background: rgba(0, 212, 255, 0.03); }
        td[contenteditable="true"]:hover { background: rgba(0, 212, 255, 0.05); }
        td[contenteditable="true"]:focus { outline: none; background: rgba(0, 212, 255, 0.1); box-shadow: inset 0 0 0 2px var(--accent-cyan); }
        .edit-hint { font-size: 0.8rem; color: var(--text-muted); margin-left: 1rem; font-weight: 400; }
        .badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge-success { background: rgba(6, 214, 160, 0.15); color: var(--accent-green); }
        .badge-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; }
        .row-actions { display: flex; gap: 0.5rem; }
        .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .collapsible-section { background: var(--bg-secondary); border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); overflow: hidden; }
        .collapsible-header { padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .collapsible-header:hover { background: var(--bg-tertiary); }
        .collapsible-header h4 { font-weight: 500; color: var(--text-secondary); margin: 0; display: flex; align-items: center; gap: 0.5rem; }
        .collapsible-content { padding: 0 1.5rem 1.5rem 1.5rem; display: none; }
        .collapsible-content.open { display: block; }
        .collapse-icon { transition: transform 0.2s; color: var(--text-muted); }
        .collapse-icon.open { transform: rotate(180deg); }
        .column-inputs { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .input-group label { font-size: 0.75rem; color: var(--text-secondary); }
        .input-group .optional { color: var(--text-muted); font-style: italic; }
        input[type="text"], select {
            font-family: 'Outfit', sans-serif; padding: 0.75rem 1rem; border-radius: 8px;
            border: 1px solid var(--border-color); background: var(--bg-tertiary);
            color: var(--text-primary); font-size: 0.9rem;
        }
        input[type="text"]:focus, select:focus { outline: none; border-color: var(--accent-cyan); }
        .extraction-preview {
            background: var(--bg-tertiary); border-radius: 12px; padding: 1.5rem;
            margin-bottom: 1.5rem; border: 1px solid var(--accent-cyan); display: none;
        }
        .extraction-preview.visible { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .extraction-preview h4 { color: var(--accent-cyan); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .preview-item { background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px; }
        .preview-item label { display: block; font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
        .preview-item .value { font-family: 'JetBrains Mono', monospace; font-size: 1rem; }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        #fileInput { display: none; }
        .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 1rem 1.5rem; border-radius: 10px; display: flex; align-items: center; gap: 0.75rem; animation: slideInRight 0.3s ease; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-magenta); }
        .footer-stats { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 1rem 1.5rem; background: var(--bg-secondary); border-radius: 12px; font-size: 0.85rem; color: var(--text-secondary); flex-wrap: wrap; gap: 1rem; }
        .stat-group { display: flex; gap: 2rem; flex-wrap: wrap; }
        .cell-link { color: var(--accent-cyan); text-decoration: none; }
        .cell-link:hover { text-decoration: underline; }
        .tooltip {
            position: fixed; background: var(--bg-primary); border: 1px solid var(--accent-cyan);
            padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.8rem; color: var(--text-primary);
            max-width: 280px; z-index: 9999; pointer-events: none; opacity: 0; transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .tooltip.visible { opacity: 1; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); z-index: 10000; display: none;
            align-items: center; justify-content: center; padding: 2rem;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border-color);
            max-width: 700px; width: 100%; max-height: 80vh; overflow-y: auto;
        }
        .modal-header {
            padding: 1.5rem; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 1.25rem; color: var(--accent-cyan); }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0; width: auto; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 1.5rem; }
        .modal-body h3 { color: var(--accent-cyan); margin: 1.5rem 0 0.75rem 0; font-size: 1rem; }
        .modal-body h3:first-child { margin-top: 0; }
        .modal-body p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 0.75rem; }
        .modal-body ul { color: var(--text-secondary); margin-left: 1.5rem; line-height: 1.8; }
        .modal-body code { background: var(--bg-tertiary); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; }
        .printer-display { display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; }
        .printer-display strong { color: var(--accent-cyan); }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            header { flex-direction: column; gap: 1rem; text-align: center; }
            .header-actions { justify-content: center; }
            .column-inputs { flex-direction: column; }
            .preview-grid { grid-template-columns: 1fr 1fr; }
            .table-header { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üñ®Ô∏è</div>
                <h1>Resin Print Catalog<span>Print Settings Tracker</span></h1>
            </div>
            <div class="header-actions">
                <button class="btn-help" onclick="showHelp()">‚ùì Help</button>
                <button class="btn-secondary" onclick="exportCSV()">üì• Export CSV</button>
                <button class="btn-primary" onclick="document.getElementById('fileInput').click()">üìÇ Import GOO</button>
                <button class="btn-danger" onclick="resetData()">üóëÔ∏è Reset</button>
            </div>
        </header>
        <input type="file" id="fileInput" accept=".goo" multiple onchange="handleFileSelect(event)">
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div class="drop-zone-icon">üìÅ</div>
            <h3>Drop GOO files here</h3>
            <p>Or click to browse ‚Ä¢ Extracts layer height, exposure times, and more automatically</p>
        </div>
        <div class="extraction-preview" id="extractionPreview">
            <h4>‚ú® Extracted from GOO File</h4>
            <div class="preview-grid" id="previewGrid"></div>
            <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                <button class="btn-primary" onclick="confirmExtraction()">‚úì Add to Catalog</button>
                <button class="btn-secondary" onclick="cancelExtraction()">‚úï Cancel</button>
            </div>
        </div>
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleSection('printerSection')">
                <h4>üñ®Ô∏è Printer Selection</h4>
                <span class="collapse-icon" id="printerSectionIcon">‚ñº</span>
            </div>
            <div class="collapsible-content" id="printerSectionContent">
                <div class="column-inputs">
                    <div class="input-group">
                        <label>Select Printer</label>
                        <select id="printerSelect" onchange="updatePrinterSelect()">
                            <option value="">-- Select --</option>
                            <option value="ELEGOO Saturn 4 Ultra 16K">ELEGOO Saturn 4 Ultra 16K</option>
                            <option value="ELEGOO Saturn 3 Ultra">ELEGOO Saturn 3 Ultra</option>
                            <option value="ELEGOO Saturn 2">ELEGOO Saturn 2</option>
                            <option value="ELEGOO Mars 4 Ultra">ELEGOO Mars 4 Ultra</option>
                            <option value="ELEGOO Mars 3 Pro">ELEGOO Mars 3 Pro</option>
                            <option value="Anycubic Photon M3">Anycubic Photon M3</option>
                            <option value="Anycubic Photon Mono X">Anycubic Photon Mono X</option>
                            <option value="Phrozen Sonic Mini 8K">Phrozen Sonic Mini 8K</option>
                            <option value="custom">Other (Enter manually)</option>
                        </select>
                    </div>
                    <div class="input-group" id="customPrinterGroup" style="display: none;">
                        <label>Custom Printer Name</label>
                        <input type="text" id="customPrinterName" placeholder="Enter printer name...">
                    </div>
                    <button class="btn-secondary" onclick="savePrinter()">Save Printer</button>
                </div>
                <div class="printer-display" style="margin-top: 1rem;">Current: <strong id="currentPrinterDisplay">Not set</strong></div>
            </div>
        </div>
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleSection('columnSection')">
                <h4>‚ûï Add Custom Column</h4>
                <span class="collapse-icon" id="columnSectionIcon">‚ñº</span>
            </div>
            <div class="collapsible-content" id="columnSectionContent">
                <div class="column-inputs">
                    <div class="input-group">
                        <label>Column Name</label>
                        <input type="text" id="newColumnName" placeholder="Column name...">
                    </div>
                    <div class="input-group">
                        <label>Type</label>
                        <select id="newColumnType">
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="link">Link/URL</option>
                            <option value="boolean">Yes/No</option>
                        </select>
                    </div>
                    <div class="input-group" style="flex: 1; min-width: 200px;">
                        <label>Description <span class="optional">(optional - shows on hover)</span></label>
                        <input type="text" id="newColumnDesc" placeholder="What does this column track?">
                    </div>
                    <button class="btn-secondary" onclick="addColumn()">Add Column</button>
                </div>
            </div>
        </div>
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">Print Settings Catalog <span class="record-count" id="recordCount">0</span><span class="edit-hint">‚Ä¢ Click any cell to edit</span></div>
                <div class="table-actions"><button class="btn-primary" onclick="addManualEntry()">‚ûï Add Entry</button></div>
            </div>
            <div class="table-wrapper"><table id="dataTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table></div>
        </div>
        <div class="footer-stats">
            <div class="stat-group">
                <span>Total Prints: <strong id="totalPrints">0</strong></span>
                <span>Successful: <strong id="successfulPrints">0</strong></span>
                <span>Total Resin: <strong id="totalResin">0</strong> mL</span>
            </div>
            <div><span style="color: var(--text-muted);">Data stored in browser localStorage</span></div>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üìñ How to Use This Tool</h2>
                <button class="modal-close" onclick="closeHelp()">√ó</button>
            </div>
            <div class="modal-body">
                <h3>üéØ What This Tool Does</h3>
                <p>This catalog helps you track and organize your resin 3D print settings. It automatically extracts metadata from GOO slicer files and lets you manually record additional details about each print.</p>
                <h3>üìÇ Importing GOO Files</h3>
                <p>Drag and drop <code>.goo</code> files onto the drop zone (or click to browse). The tool will automatically extract:</p>
                <ul>
                    <li><strong>Layer Height</strong> - The thickness of each printed layer</li>
                    <li><strong>Exposure Times</strong> - Bottom and normal layer cure times</li>
                    <li><strong>Transition Layers</strong> - Gradual exposure reduction layers</li>
                    <li><strong>Model Dimensions</strong> - X, Y, Z size of your print</li>
                    <li><strong>Wait Time</strong> - Delay before UV exposure</li>
                </ul>
                <h3>‚úèÔ∏è Editing Data</h3>
                <p>Click any cell in the table to edit it directly. Changes are saved automatically to your browser's local storage.</p>
                <h3>üìä Column Descriptions</h3>
                <p>Hover over any column header to see a description of what that parameter means and how it affects your prints.</p>
                <h3>‚ûï Custom Columns</h3>
                <p>Need to track something specific? Expand "Add Custom Column" to create your own columns. You can optionally add a description that appears when hovering over the column header.</p>
                <h3>üñ®Ô∏è Printer Selection</h3>
                <p>Select your printer from the dropdown or enter a custom name. This is saved for your reference.</p>
                <h3>üì• Exporting Data</h3>
                <p>Click "Export CSV" to download your catalog as a spreadsheet file. You can open this in Excel, Google Sheets, or any spreadsheet application.</p>
                <h3>‚ö†Ô∏è Data Storage</h3>
                <p>All data is stored locally in your browser. This means:</p>
                <ul>
                    <li>Your data stays on your device</li>
                    <li>Different browsers/devices have separate data</li>
                    <li>Clearing browser data will erase your catalog</li>
                    <li>Use "Export CSV" regularly to back up your data!</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>
    <script>
        const columnTooltips = {
            print_name: "The name of your print file or model",
            date: "When the file was sliced or printed",
            layer_height_mm: "Thickness of each layer. Lower = more detail but longer print time. Common: 0.03-0.05mm detailed, 0.05-0.10mm faster",
            bottom_layers: "Layers with extended exposure for bed adhesion. Usually 4-8 layers",
            transition_layers: "Layers that gradually reduce exposure from bottom to normal. Prevents separation",
            bottom_exposure_s: "UV time for bottom layers. Longer = stronger adhesion. Usually 25-60s",
            normal_exposure_s: "UV time for regular layers. Affects detail and success. Usually 1.5-3s",
            wait_before_cure_s: "Delay after lift before UV. Allows resin to settle. Usually 0.5-2s",
            model_x_mm: "Model width (left-right on build plate)",
            model_y_mm: "Model depth (front-back on build plate)",
            model_z_mm: "Model height (vertical)",
            success: "Did this print complete successfully?",
            hollow: "Is the model hollowed? Saves resin but needs drain holes",
            wall_thickness_mm: "Wall thickness if hollow. Usually 1.5-3mm",
            drain_hole_mm: "Drain hole diameter. Usually 2-4mm",
            drain_hole_coords: "Location of drain holes on model",
            supports: "Support type: light, medium, heavy, or none",
            resin_ml: "Resin used in milliliters",
            cure_time_s: "Post-print UV curing time in seconds",
            notes: "Additional notes about this print"
        };

        class GooParser {
            constructor(ab) { this.data = new DataView(ab); this.bytes = new Uint8Array(ab); }
            readString(o, m) { let r=''; for(let i=0;i<m;i++){const c=this.bytes[o+i];if(c===0)break;if(c>=32&&c<=126)r+=String.fromCharCode(c);} return r; }
            readFloatBE(o) { return this.data.getFloat32(o, false); }
            findBytes(p, s=0) { const pb=new Uint8Array(p); for(let i=s;i<=this.bytes.length-pb.length;i++){let m=true;for(let j=0;j<pb.length;j++){if(this.bytes[i+j]!==pb[j]){m=false;break;}}if(m)return i;} return -1; }
            floatToBytesBE(v) { const b=new ArrayBuffer(4); new DataView(b).setFloat32(0,v,false); return new Uint8Array(b); }
            parse() {
                const r = {version:this.readString(0,4),software_name:this.readString(0x0C,32),printer_name:this.readString(0x5C,40),slice_datetime:this.readString(0x44,20),layer_height_mm:null,normal_exposure_s:null,bottom_exposure_s:null,bottom_layers:null,transition_layers:null,wait_before_cure_s:null,model_x_mm:null,model_y_mm:null,model_z_mm:null,estimated_layer_count:null};
                const ch=[0.02,0.03,0.04,0.05,0.06,0.08,0.10]; let lhp=-1;
                for(const h of ch){const b=this.floatToBytesBE(h);const p=this.findBytes(b,0x1000);if(p>0&&p<0x100000){const nf=this.readFloatBE(p+4);if(nf>0.5&&nf<200){r.layer_height_mm=h;r.normal_exposure_s=nf;lhp=p;break;}}}
                if(lhp>16){const d1=this.readFloatBE(lhp-12),d2=this.readFloatBE(lhp-8),d3=this.readFloatBE(lhp-4);if(d1>0&&d1<500&&d2>0&&d2<500&&d3>0&&d3<500){r.model_x_mm=Math.round(d1*100)/100;r.model_y_mm=Math.round(d2*100)/100;r.model_z_mm=Math.round(d3*100)/100;}
                if(r.layer_height_mm){const z2b=this.floatToBytesBE(r.layer_height_mm*2);const z2p=this.findBytes(z2b,lhp+100);if(z2p>0){const l2e=this.readFloatBE(z2p+4);if(l2e>10&&l2e<200)r.bottom_exposure_s=l2e;const wt=this.readFloatBE(z2p+0x14);if(wt>0&&wt<30)r.wait_before_cure_s=Math.round(wt*100)/100;}
                let bc=0,tc=0,le=r.bottom_exposure_s||45,it=false;for(let i=1;i<=30;i++){const zb=this.floatToBytesBE(r.layer_height_mm*i);const zp=this.findBytes(zb,lhp+100);if(zp>0){const e=this.readFloatBE(zp+4);if(e>0&&e<200){if(!it&&Math.abs(e-le)<1)bc++;else if(e<le*0.95&&e>r.normal_exposure_s*1.1){it=true;tc++;}else if(Math.abs(e-r.normal_exposure_s)<0.5)break;le=e;}}}if(bc>0)r.bottom_layers=bc;if(tc>0)r.transition_layers=tc;}}
                if(r.model_z_mm&&r.layer_height_mm)r.estimated_layer_count=Math.round(r.model_z_mm/r.layer_height_mm);
                return r;
            }
        }

        const defaultColumns=[{id:'print_name',name:'Print Name',type:'text',visible:true},{id:'date',name:'Date',type:'text',visible:true},{id:'layer_height_mm',name:'Layer Height (mm)',type:'number',visible:true},{id:'bottom_layers',name:'Bottom Layers',type:'number',visible:true},{id:'transition_layers',name:'Transition Layers',type:'number',visible:true},{id:'bottom_exposure_s',name:'Bottom Exp (s)',type:'number',visible:true},{id:'normal_exposure_s',name:'Normal Exp (s)',type:'number',visible:true},{id:'wait_before_cure_s',name:'Wait Before Cure (s)',type:'number',visible:true},{id:'model_x_mm',name:'Model X (mm)',type:'number',visible:true},{id:'model_y_mm',name:'Model Y (mm)',type:'number',visible:true},{id:'model_z_mm',name:'Model Z (mm)',type:'number',visible:true},{id:'success',name:'Success',type:'boolean',visible:true},{id:'hollow',name:'Hollow',type:'boolean',visible:true},{id:'wall_thickness_mm',name:'Wall (mm)',type:'number',visible:true},{id:'drain_hole_mm',name:'Drain Hole (mm)',type:'number',visible:true},{id:'drain_hole_coords',name:'Drain Coords',type:'text',visible:false},{id:'supports',name:'Supports',type:'text',visible:true},{id:'resin_ml',name:'Resin (mL)',type:'number',visible:true},{id:'cure_time_s',name:'Post-Cure (s)',type:'number',visible:true},{id:'notes',name:'Notes',type:'text',visible:true}];
        let columns=JSON.parse(localStorage.getItem('printCatalogColumns'))||defaultColumns;
        let data=JSON.parse(localStorage.getItem('printCatalogData'))||[];
        let printer=localStorage.getItem('printCatalogPrinter')||'';
        let customTooltips=JSON.parse(localStorage.getItem('printCatalogTooltips'))||{};
        let pendingExtraction=null,sortColumn=null,sortDirection='asc';
        const tooltip=document.getElementById('tooltip');

        function saveData(){localStorage.setItem('printCatalogData',JSON.stringify(data));localStorage.setItem('printCatalogColumns',JSON.stringify(columns));localStorage.setItem('printCatalogTooltips',JSON.stringify(customTooltips));}
        function showToast(m,t='success'){const c=document.getElementById('toastContainer');const to=document.createElement('div');to.className=`toast ${t}`;to.innerHTML=`<span>${t==='success'?'‚úì':'‚úï'}</span><span>${m}</span>`;c.appendChild(to);setTimeout(()=>to.remove(),4000);}
        function showTooltip(e,t){if(!t)return;tooltip.textContent=t;tooltip.classList.add('visible');positionTooltip(e);}
        function positionTooltip(e){tooltip.style.left=(e.clientX+15)+'px';tooltip.style.top=(e.clientY+15)+'px';}
        function hideTooltip(){tooltip.classList.remove('visible');}
        function renderTable(){
            const vc=columns.filter(c=>c.visible);const th=document.getElementById('tableHead');
            th.innerHTML=`<tr>${vc.map(c=>{const tt=(customTooltips[c.id]||columnTooltips[c.id]||'').replace(/'/g,"\\'");return`<th onclick="sortBy('${c.id}')" onmouseenter="showTooltip(event,'${tt}')" onmousemove="positionTooltip(event)" onmouseleave="hideTooltip()">${c.name}</th>`;}).join('')}<th>Actions</th></tr>`;
            const tb=document.getElementById('tableBody');
            if(data.length===0){tb.innerHTML=`<tr><td colspan="${vc.length+1}"><div class="empty-state"><div class="empty-state-icon">üìã</div><p>No print records yet. Drop a GOO file or click "Add Entry".</p></div></td></tr>`;}
            else{const sd=[...data];if(sortColumn){sd.sort((a,b)=>{let va=a[sortColumn]||'',vb=b[sortColumn]||'';if(typeof va==='number'&&typeof vb==='number')return sortDirection==='asc'?va-vb:vb-va;va=String(va).toLowerCase();vb=String(vb).toLowerCase();return sortDirection==='asc'?va.localeCompare(vb):vb.localeCompare(va);});}
            tb.innerHTML=sd.map((row,i)=>`<tr>${vc.map(c=>`<td contenteditable="true" data-col="${c.id}" onblur="updateCell(this,${data.indexOf(row)},'${c.id}')">${formatCell(row[c.id],c.type)}</td>`).join('')}<td><div class="row-actions"><button class="btn-icon btn-secondary" onclick="duplicateRow(${data.indexOf(row)})" title="Duplicate">üìã</button><button class="btn-icon btn-danger" onclick="deleteRow(${data.indexOf(row)})" title="Delete">üóëÔ∏è</button></div></td></tr>`).join('');}
            document.getElementById('recordCount').textContent=data.length;document.getElementById('totalPrints').textContent=data.length;
            document.getElementById('successfulPrints').textContent=data.filter(d=>d.success===true||d.success==='Yes').length;
            document.getElementById('totalResin').textContent=data.reduce((s,d)=>s+(parseFloat(d.resin_ml)||0),0).toFixed(1);
        }
        function formatCell(v,t){if(v===null||v===undefined||v==='')return'';switch(t){case'boolean':const y=v===true||v==='Yes'||v==='yes'||v==='1';return`<span class="badge ${y?'badge-success':'badge-neutral'}">${y?'Yes':'No'}</span>`;case'number':return`<span class="mono">${v}</span>`;case'link':return v&&v.startsWith('http')?`<a href="${v}" target="_blank" class="cell-link">üîó Link</a>`:v;default:return v;}}
        function updateCell(td,ri,ci){let v=td.innerText.trim();const c=columns.find(x=>x.id===ci);if(c.type==='boolean')v=v.toLowerCase().includes('yes')||v==='1';else if(c.type==='number')v=parseFloat(v)||null;data[ri][ci]=v;saveData();renderTable();}
        function sortBy(ci){if(sortColumn===ci)sortDirection=sortDirection==='asc'?'desc':'asc';else{sortColumn=ci;sortDirection='asc';}renderTable();}
        function addManualEntry(){data.unshift({print_name:'New Print',date:new Date().toISOString().split('T')[0],success:null});saveData();renderTable();showToast('New entry added');}
        function deleteRow(i){if(confirm('Delete this entry?')){data.splice(i,1);saveData();renderTable();showToast('Entry deleted');}}
        function duplicateRow(i){const cp={...data[i],print_name:data[i].print_name+' (copy)'};data.splice(i+1,0,cp);saveData();renderTable();showToast('Entry duplicated');}
        function addColumn(){const n=document.getElementById('newColumnName').value.trim();const t=document.getElementById('newColumnType').value;const d=document.getElementById('newColumnDesc').value.trim();if(!n){showToast('Please enter a column name','error');return;}const id=n.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');if(columns.find(c=>c.id===id)){showToast('Column already exists','error');return;}columns.push({id,name:n,type:t,visible:true});if(d)customTooltips[id]=d;saveData();renderTable();document.getElementById('newColumnName').value='';document.getElementById('newColumnDesc').value='';showToast(`Column "${n}" added`);}
        function toggleSection(id){document.getElementById(id+'Content').classList.toggle('open');document.getElementById(id+'Icon').classList.toggle('open');}
        function updatePrinterSelect(){document.getElementById('customPrinterGroup').style.display=document.getElementById('printerSelect').value==='custom'?'flex':'none';}
        function savePrinter(){const s=document.getElementById('printerSelect');let pn=s.value;if(pn==='custom')pn=document.getElementById('customPrinterName').value.trim();if(!pn){showToast('Please select or enter a printer','error');return;}printer=pn;localStorage.setItem('printCatalogPrinter',printer);document.getElementById('currentPrinterDisplay').textContent=printer;showToast(`Printer: ${printer}`);}
        function loadPrinter(){if(printer){document.getElementById('currentPrinterDisplay').textContent=printer;const s=document.getElementById('printerSelect');if([...s.options].find(o=>o.value===printer))s.value=printer;else{s.value='custom';document.getElementById('customPrinterGroup').style.display='flex';document.getElementById('customPrinterName').value=printer;}}}
        function showHelp(){document.getElementById('helpModal').classList.add('visible');}
        function closeHelp(){document.getElementById('helpModal').classList.remove('visible');}
        document.getElementById('helpModal').addEventListener('click',e=>{if(e.target.id==='helpModal')closeHelp();});
        function handleFileSelect(e){for(const f of e.target.files)processGooFile(f);e.target.value='';}
        async function processGooFile(f){try{const ab=await f.arrayBuffer();const p=new GooParser(ab);const ex=p.parse();pendingExtraction={print_name:f.name.replace('.goo',''),date:ex.slice_datetime?.split(' ')[0]||new Date().toISOString().split('T')[0],layer_height_mm:ex.layer_height_mm,normal_exposure_s:ex.normal_exposure_s,bottom_exposure_s:ex.bottom_exposure_s,bottom_layers:ex.bottom_layers,transition_layers:ex.transition_layers,wait_before_cure_s:ex.wait_before_cure_s,model_x_mm:ex.model_x_mm,model_y_mm:ex.model_y_mm,model_z_mm:ex.model_z_mm,estimated_layers:ex.estimated_layer_count,printer:ex.printer_name,software:ex.software_name};showExtractionPreview(pendingExtraction);}catch(err){console.error(err);showToast('Error parsing GOO file','error');}}
        function showExtractionPreview(ex){const items=[['Print Name',ex.print_name],['Date',ex.date],['Layer Height',ex.layer_height_mm?`${ex.layer_height_mm} mm`:'N/A'],['Normal Exposure',ex.normal_exposure_s?`${ex.normal_exposure_s} s`:'N/A'],['Bottom Exposure',ex.bottom_exposure_s?`${ex.bottom_exposure_s} s`:'N/A'],['Bottom Layers',ex.bottom_layers||'N/A'],['Transition Layers',ex.transition_layers||'N/A'],['Wait Before Cure',ex.wait_before_cure_s?`${ex.wait_before_cure_s} s`:'N/A'],['Model X',ex.model_x_mm?`${ex.model_x_mm} mm`:'N/A'],['Model Y',ex.model_y_mm?`${ex.model_y_mm} mm`:'N/A'],['Model Z',ex.model_z_mm?`${ex.model_z_mm} mm`:'N/A'],['Est. Layers',ex.estimated_layers||'N/A'],['Printer',ex.printer||'N/A']];document.getElementById('previewGrid').innerHTML=items.map(([l,v])=>`<div class="preview-item"><label>${l}</label><div class="value">${v}</div></div>`).join('');document.getElementById('extractionPreview').classList.add('visible');}
        function confirmExtraction(){if(!pendingExtraction)return;data.unshift({print_name:pendingExtraction.print_name,date:pendingExtraction.date,success:null,layer_height_mm:pendingExtraction.layer_height_mm,normal_exposure_s:pendingExtraction.normal_exposure_s,bottom_exposure_s:pendingExtraction.bottom_exposure_s,bottom_layers:pendingExtraction.bottom_layers,transition_layers:pendingExtraction.transition_layers,wait_before_cure_s:pendingExtraction.wait_before_cure_s,model_x_mm:pendingExtraction.model_x_mm,model_y_mm:pendingExtraction.model_y_mm,model_z_mm:pendingExtraction.model_z_mm});saveData();renderTable();cancelExtraction();showToast('Print added!');}
        function cancelExtraction(){pendingExtraction=null;document.getElementById('extractionPreview').classList.remove('visible');}
        const dropZone=document.getElementById('dropZone');
        dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over');});
        dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('drag-over');for(const f of e.dataTransfer.files){if(f.name.endsWith('.goo'))processGooFile(f);else showToast('Please drop .goo files only','error');}});
        function resetData(){if(confirm('Reset all data? This cannot be undone.')){localStorage.removeItem('printCatalogData');localStorage.removeItem('printCatalogColumns');localStorage.removeItem('printCatalogTooltips');localStorage.removeItem('printCatalogPrinter');columns=[...defaultColumns];data=[];customTooltips={};printer='';saveData();renderTable();document.getElementById('currentPrinterDisplay').textContent='Not set';document.getElementById('printerSelect').value='';showToast('Reset complete');}}
        function exportCSV(){if(data.length===0){showToast('No data to export','error');return;}const printerVal=printer||'Not Available';const vc=columns.filter(c=>c.visible);const h=['Printer',...vc.map(c=>c.name)].join(',');const r=data.map(row=>[`"${printerVal}"`,...vc.map(c=>{let v=row[c.id]||'';v=String(v).replace(/"/g,'""');if(v.includes(',')||v.includes('"')||v.includes('\n'))v=`"${v}"`;return v;})].join(','));const csv=[h,...r].join('\n');const b=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`resin-print-catalog-${new Date().toISOString().split('T')[0]}.csv`;a.click();showToast('CSV exported!');}
        renderTable();loadPrinter();
    </script>
</body>
</html>
